name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  statuses: read
  checks: write
  pull-requests: write

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Test
        run: npm run test:run

  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --audit-level=moderate

  lighthouse:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Wait for Vercel preview
        id: vercel_preview
        uses: actions/github-script@v7
        with:
          script: |
            const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = context.sha;
            const maxAttempts = 30;
            const delayMs = 20000;
            const expectedContext = (process.env.VERCEL_STATUS_CONTEXT || "").toLowerCase().trim();

            for (let attempt = 1; attempt <= maxAttempts; attempt += 1) {
              const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
                owner,
                repo,
                ref,
                per_page: 100
              });

              const match = statuses.find((status) => {
                if (status.state !== "success" || !status.target_url) {
                  return false;
                }
                const contextName = (status.context || "").toLowerCase();
                const url = status.target_url.toLowerCase();
                if (expectedContext) {
                  return contextName === expectedContext;
                }
                return contextName.includes("vercel") || url.includes("vercel.app");
              });

              if (match) {
                core.info(`Found Vercel deployment: ${match.target_url}`);
                core.setOutput("url", match.target_url);
                return;
              }

              core.info(`Waiting for Vercel preview... (${attempt}/${maxAttempts})`);
              await wait(delayMs);
            }

            core.setFailed("Timed out waiting for Vercel preview deployment URL.");
        env:
          VERCEL_STATUS_CONTEXT: ${{ vars.VERCEL_STATUS_CONTEXT }}

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: ${{ steps.vercel_preview.outputs.url }}
          runs: 3
          configPath: ./lighthouserc.json
          uploadArtifacts: true
