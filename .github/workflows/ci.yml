name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  deployments: read
  checks: write
  pull-requests: write

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Test
        run: npm run test:run

  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --audit-level=moderate

  lighthouse:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Wait for Vercel preview
        id: vercel_preview
        uses: actions/github-script@v7
        with:
          script: |
            const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = context.sha;
            const maxAttempts = 24;
            const delayMs = 10000;
            const environment = "Preview";

            for (let attempt = 1; attempt <= maxAttempts; attempt += 1) {
              const { data: deployments } = await github.rest.repos.listDeployments({
                owner,
                repo,
                environment,
                ref,
                per_page: 100
              });

              core.info(
                `Deployments found: ${JSON.stringify(
                  deployments.map((d) => ({ id: d.id, environment: d.environment, sha: d.sha, created_at: d.created_at })),
                  null,
                  2
                )}`
              );

              if (deployments.length > 0) {
                const deploymentId = deployments[0].id;
                const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                  owner,
                  repo,
                  deployment_id: deploymentId,
                  per_page: 100
                });

                if (statuses.length > 0) {
                  core.info(
                    `Deployment statuses: ${JSON.stringify(
                      statuses.map((s) => ({ id: s.id, state: s.state, environment_url: s.environment_url, target_url: s.target_url, description: s.description })),
                      null,
                      2
                    )}`
                  );
                }

                // Vercel usually sets environment_url; target_url is a fallback used by some
                // older integrations. The description field occasionally contains the preview
                // URL when both URL fields are empty (observed with some Vercel bot versions).
                // The regex ensures only *.vercel.app HTTPS URLs are accepted from description.
                const VERCEL_URL_RE = /^https:\/\/[^/]+\.vercel\.app(\/.*)?$/;
                const success = statuses.find((status) => status.state === "success");
                const url =
                  success?.environment_url ||
                  success?.target_url ||
                  (VERCEL_URL_RE.test(success?.description ?? "") ? success.description : null);

                if (url) {
                  core.info(`Found Vercel preview: ${url}`);
                  core.setOutput("url", url);
                  return;
                }
              }

              core.info(`Waiting for Vercel preview deployment... (${attempt}/${maxAttempts})`);
              await wait(delayMs);
            }

            core.setFailed("Timed out waiting for Vercel preview deployment URL.");

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: ${{ steps.vercel_preview.outputs.url }}
          runs: 3
          configPath: ./lighthouserc.json
          uploadArtifacts: true
